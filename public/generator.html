<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teachable Streak Widget - Code Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 36px;
            margin-bottom: 12px;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 24px;
        }
        .form-group {
            margin-bottom: 24px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .output {
            display: none;
            margin-top: 30px;
        }
        .output.visible {
            display: block;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 600;
        }
        .code-container {
            position: relative;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin-top: 16px;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .copy-btn:hover {
            background: #5568d3;
        }
        .copy-btn.copied {
            background: #10b981;
        }
        pre {
            margin: 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding-top: 30px;
        }
        .preview {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }
        .preview h3 {
            margin-bottom: 20px;
            color: #333;
        }
        small {
            display: block;
            color: #666;
            font-size: 13px;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”¥ Teachable Streak Widget Generator</h1>
            <p style="opacity: 0.9;">Create your personalized streak tracking code</p>
        </div>

        <div class="card">
            <div class="form-group">
                <label for="schoolId">Your School ID</label>
                <input
                    type="text"
                    id="schoolId"
                    placeholder="e.g., 1371193"
                    value="1371193"
                >
                <small>This is your unique Teachable student ID (usually a number)</small>
            </div>

            <div class="form-group">
                <label for="apiUrl">API Server URL</label>
                <input
                    type="text"
                    id="apiUrl"
                    value="https://teachable-streak-tracker.onrender.com/api"
                >
                <small>
                    <strong>Production:</strong> https://teachable-streak-tracker.onrender.com/api<br>
                    <strong>Local testing:</strong> http://localhost:3000/api
                </small>
            </div>

            <button class="btn" onclick="generateCode()">Generate Widget Code</button>

            <div id="output" class="output">
                <div class="success">
                    âœ… Code generated! Copy and paste into your Teachable custom code section.
                </div>

                <h3>Step 1: Copy This Code</h3>
                <div class="code-container">
                    <button class="copy-btn" onclick="copyCode()">ðŸ“‹ Copy</button>
                    <pre id="generated-code"></pre>
                </div>

                <div class="preview">
                    <h3>Step 2: Preview</h3>
                    <div id="preview-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function generateCode() {
            const schoolId = document.getElementById('schoolId').value.trim();
            const apiUrl = document.getElementById('apiUrl').value.trim();

            if (!schoolId) {
                alert('Please enter your School ID');
                return;
            }

            if (!apiUrl) {
                alert('Please enter API URL');
                return;
            }

            // Generate the code
            const code = createEmbedCode(schoolId, apiUrl);

            // Display it
            document.getElementById('generated-code').textContent = code;
            document.getElementById('output').classList.add('visible');

            // Show preview
            loadPreview(schoolId, apiUrl);
        }

        function createEmbedCode(schoolId, apiUrl) {
            // Return the embed code as a string (no template literals inside)
            const code = '<!-- Teachable Streak Widget -->\n' +
                '<div id="teachable-streak-widget"></div>\n\n' +
                '<style>\n' +
                '    #teachable-streak-widget {\n' +
                '        max-width: 500px;\n' +
                '        margin: 20px auto;\n' +
                '        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n' +
                '    }\n' +
                '    .streak-widget-card {\n' +
                '        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n' +
                '        border-radius: 16px;\n' +
                '        padding: 32px;\n' +
                '        color: white;\n' +
                '        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);\n' +
                '        text-align: center;\n' +
                '    }\n' +
                '    .streak-fire { font-size: 48px; margin-bottom: 12px; animation: flicker 2s infinite; }\n' +
                '    @keyframes flicker { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }\n' +
                '    .streak-number { font-size: 64px; font-weight: 800; margin-bottom: 8px; }\n' +
                '    .streak-label { font-size: 18px; opacity: 0.9; margin-bottom: 16px; }\n' +
                '    .streak-message { background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; margin-top: 16px; }\n' +
                '    .streak-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }\n' +
                '    .stat-item { background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; }\n' +
                '    .stat-value { font-size: 24px; font-weight: 700; }\n' +
                '    .stat-label { font-size: 12px; opacity: 0.8; }\n' +
                '    .streak-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 16px; }\n' +
                '    .calendar-day { aspect-ratio: 1; background: rgba(255,255,255,0.2); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; }\n' +
                '    .calendar-day.active { background: rgba(255,215,0,0.9); }\n' +
                '</style>\n\n' +
                '<script>\n' +
                '(function() {\n' +
                '    // Only run on /l/dashboard page\n' +
                '    if (!window.location.pathname.includes("/l/dashboard")) {\n' +
                '        return; // Exit if not on dashboard\n' +
                '    }\n\n' +
                '    const SCHOOL_ID = "' + schoolId + '";\n' +
                '    const API_URL = "' + apiUrl + '";\n\n' +
                '    async function loadStreak() {\n' +
                '        const container = document.getElementById("teachable-streak-widget");\n' +
                '        if (!container) return;\n\n' +
                '        try {\n' +
                '            container.innerHTML = "<div style=\'padding: 40px; text-align: center;\'>Loading streak...</div>";\n\n' +
                '            const response = await fetch(API_URL + "/visit", {\n' +
                '                method: "POST",\n' +
                '                headers: { "Content-Type": "application/json" },\n' +
                '                body: JSON.stringify({ schoolId: SCHOOL_ID })\n' +
                '            });\n\n' +
                '            if (!response.ok) throw new Error("Failed to load");\n\n' +
                '            const data = await response.json();\n' +
                '            renderWidget(data);\n' +
                '        } catch (error) {\n' +
                '            console.error("Streak error:", error);\n' +
                '            container.innerHTML = "<div style=\'padding: 20px; text-align: center; color: #c33;\'>Failed to load streak</div>";\n' +
                '        }\n' +
                '    }\n\n' +
                '    function renderWidget(data) {\n' +
                '        const messages = {\n' +
                '            1: "You\'re back! Let\'s build a streak! ðŸ’ª",\n' +
                '            3: "3 days! Building a habit! ðŸ”¥",\n' +
                '            7: "One week! Unstoppable! ðŸš€",\n' +
                '            30: "30 days! Legend! ðŸ‘‘"\n' +
                '        };\n' +
                '        const message = data.isNewUser ? "Welcome! Your journey begins! ðŸŽ‰" : (messages[data.currentStreak] || data.currentStreak + " days! On fire! ðŸ”¥");\n\n' +
                '        const calendar = renderCalendar(data.visitDates || []);\n\n' +
                '        const html = \'<div class="streak-widget-card">\' +\n' +
                '            \'<div class="streak-fire">ðŸ”¥</div>\' +\n' +
                '            \'<div class="streak-number">\' + data.currentStreak + \'</div>\' +\n' +
                '            \'<div class="streak-label">\' + (data.currentStreak === 1 ? "day" : "days") + \' in a row</div>\' +\n' +
                '            \'<div class="streak-calendar">\' + calendar + \'</div>\' +\n' +
                '            \'<div class="streak-message">\' + message + \'</div>\' +\n' +
                '            \'<div class="streak-stats">\' +\n' +
                '                \'<div class="stat-item"><div class="stat-value">\' + data.longestStreak + \'</div><div class="stat-label">Longest</div></div>\' +\n' +
                '                \'<div class="stat-item"><div class="stat-value">\' + data.totalVisits + \'</div><div class="stat-label">Total</div></div>\' +\n' +
                '            \'</div>\' +\n' +
                '        \'</div>\';\n\n' +
                '        document.getElementById("teachable-streak-widget").innerHTML = html;\n' +
                '    }\n\n' +
                '    function renderCalendar(visitDates) {\n' +
                '        let html = "";\n' +
                '        const today = new Date();\n' +
                '        today.setHours(0, 0, 0, 0);\n' +
                '        const days = ["S", "M", "T", "W", "T", "F", "S"];\n\n' +
                '        for (let i = 6; i >= 0; i--) {\n' +
                '            const date = new Date(today);\n' +
                '            date.setDate(date.getDate() - i);\n' +
                '            const dateStr = date.toISOString().split("T")[0];\n' +
                '            const isActive = visitDates.includes(dateStr);\n' +
                '            const dayLabel = days[date.getDay()];\n' +
                '            html += \'<div class="calendar-day \' + (isActive ? "active" : "") + \'">\' + dayLabel + \'</div>\';\n' +
                '        }\n' +
                '        return html;\n' +
                '    }\n\n' +
                '    if (document.readyState === "loading") {\n' +
                '        document.addEventListener("DOMContentLoaded", loadStreak);\n' +
                '    } else {\n' +
                '        loadStreak();\n' +
                '    }\n' +
                '})();\n' +
                '<\/script>';

            return code;
        }

        function copyCode() {
            const code = document.getElementById('generated-code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btn = event.target;
                btn.textContent = 'âœ… Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'ðŸ“‹ Copy';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        async function loadPreview(schoolId, apiUrl) {
            const container = document.getElementById('preview-container');

            try {
                const response = await fetch(apiUrl + '/visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schoolId })
                });

                const data = await response.json();

                const message = data.isNewUser ? "Welcome! Your journey begins! ðŸŽ‰" : data.currentStreak + " days! On fire! ðŸ”¥";

                container.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 16px;
                        padding: 32px;
                        color: white;
                        text-align: center;
                        max-width: 500px;
                        margin: 0 auto;
                    ">
                        <div style="font-size: 48px; margin-bottom: 12px;">ðŸ”¥</div>
                        <div style="font-size: 64px; font-weight: 800; margin-bottom: 8px;">${data.currentStreak}</div>
                        <div style="font-size: 18px; opacity: 0.9; margin-bottom: 16px;">${data.currentStreak === 1 ? 'day' : 'days'} in a row</div>
                        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; margin-top: 16px;">${message}</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 700;">${data.longestStreak}</div>
                                <div style="font-size: 12px; opacity: 0.8;">Longest</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 700;">${data.totalVisits}</div>
                                <div style="font-size: 12px; opacity: 0.8;">Total</div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<div style="color: #c33;">Failed to load preview. Make sure server is running.</div>';
            }
        }
    </script>
</body>
</html>
